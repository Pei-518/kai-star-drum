<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¯”è³½æˆç¸¾æŸ¥è©¢</title>
  <style>
    :root{
      --bg:#f0f5ff; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --primary:#1d4ed8; --primary-weak:#dbeafe; --border:#e5e7eb;
      --thead:#eff6ff; --radius:16px; --shadow:0 10px 24px rgba(2,6,23,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial,"Apple Color Emoji";}
    .container{max-width:980px;margin:28px auto;padding:0 16px}
    h1{font-size:26px;margin:0 0 16px;text-align:center;color:#0b3aa7}

    .card{background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;}

    header.controls{display:grid;gap:12px;grid-template-columns: 1fr max-content max-content;align-items:end;margin-bottom:12px}
    @media (max-width:720px){header.controls{grid-template-columns:1fr;}}
    label{font-size:13px;color:var(--muted)}
    select,button{width:100%;font-size:16px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    select:focus{outline:2px solid var(--primary-weak);border-color:var(--primary)}
    .btn{background:#eff6ff;color:#0b3aa7;border:1px solid #c7d2fe;cursor:pointer}

    .table-wrap{margin-top:4px;border:1px solid var(--border);border-radius:12px;overflow:auto;background:#fff;box-shadow:var(--shadow);position:relative}
    table{width:100%;border-collapse:collapse;min-width:560px;table-layout:fixed}
    thead th{position:sticky;top:0;z-index:1;background:var(--thead);color:#0b3aa7;font-weight:700;border-bottom:1px solid #c7d2fe;padding:10px 12px;text-align:left}
    tbody td{border-bottom:1px solid var(--border);padding:10px 12px;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    tbody tr:nth-child(odd){background:#f8fbff}
    tbody tr:hover{background:#eef5ff}
    th.rank, td.rank{width:140px}
    th.group, td.group{width:160px}
    th.score, td.score{width:120px}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border-radius:999px;font-weight:700;font-size:14px;background:#e0e7ff;color:#1e3a8a;border:1px solid #c7d2fe}
    .rank-1{background:#ffeab5;color:#8a4b00;border-color:#ffd58a}
    .rank-2{background:#e2e8f0;color:#334155;border-color:#cbd5e1}
    .rank-3{background:#fde68a;color:#7c2d12;border-color:#fcd34d}

    .loading{position:absolute;inset:0;display:none;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(239,246,255,.85), rgba(239,246,255,.6));
      backdrop-filter:saturate(180%) blur(2px);border-radius:12px}
    .loading.show{display:flex}
    .spinner{width:42px;height:42px;border-radius:50%;border:4px solid #c7d2fe;border-top-color:#1d4ed8;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .empty-below{display:none;text-align:center;color:#0b3aa7;margin-top:14px;padding:14px 12px;background:#f5f9ff;border:1px dashed #c7d2fe;border-radius:12px}
    .empty-below.show{display:block}
  </style>
</head>
<body>
  <div class="container">
    <h1>æ¯”è³½æˆç¸¾æŸ¥è©¢</h1>

    <div class="card">
      <header class="controls">
        <div>
          <label for="sheetSelect">åˆ†é ï¼ˆçµ„åˆ¥ï¼‰</label>
          <select id="sheetSelect">
            <option value="">é¸æ“‡çµ„åˆ¥</option>
          </select>
        </div>
        <button id="btnReload" class="btn" type="button">é‡æ–°è¼‰å…¥</button>
        <button id="btnClear"  class="btn" type="button">æ¸…é™¤</button>
      </header>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th class="rank">çµ„å…§åæ¬¡</th>
              <th>å§“å</th>
              <th class="group">çµ„åˆ¥</th>
              <th class="score">æˆç¸¾</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="loading" class="loading"><div class="spinner"></div></div>
      </div>

      <div id="emptyBelow" class="empty-below">è«‹é¸æ“‡çµ„åˆ¥</div>
    </div>
  </div>

  <script>
    // ä½ çš„ Apps Script Web App URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyq2bxSn8QtViO_zI02gvorzAoGB3AUq23ph6Bo_ALotdz4rjIJHEPuJKA0vze3TF8R/exec";

    // æ¬„ä½å°æ‡‰ï¼šè¦åŒ…å«ã€Œåæ¬¡ã€
    const COL = { name:"å§“å", group:"çµ„åˆ¥", score:"æˆç¸¾", rank:"åæ¬¡" };

    const $sheet = document.getElementById('sheetSelect');
    const $tbody = document.querySelector('#tbl tbody');
    const $btnClr = document.getElementById('btnClear');
    const $btnRel = document.getElementById('btnReload');
    const $loading = document.getElementById('loading');
    const $emptyBelow = document.getElementById('emptyBelow');

    let allData = [];
    let dataset = [];

    const toNumber = x => (typeof x==='number') ? x : Number(String(x ?? '').replace(/[, ]/g,''));
    const showLoading = on => $loading.classList.toggle('show', !!on);
    const showEmptyBelow = on => $emptyBelow.classList.toggle('show', !!on);
    const norm = s => String(s || '').trim();

    // åæ¬¡é¡¯ç¤ºï¼š1~3 æœ‰çç‰Œï¼Œå…¶é¤˜åªæœ‰æ•¸å­—ï¼ˆä¸åŠ çç‰Œï¼‰
    function rankBadge(rank){
      const n = Number(rank);
      if (!n) return '';
      if (n === 1 || n === 2 || n === 3){
        const medal = n===1?'ğŸ¥‡':n===2?'ğŸ¥ˆ':'ğŸ¥‰';
        const cls = n===1?'rank-1':n===2?'rank-2':'rank-3';
        return `<span class="badge ${cls}">${medal}<span>${n}</span></span>`;
      }
      // ç¬¬4åä»¥å¾Œï¼šç„¡çç‰Œ
      return `<span class="badge"><span>${n}</span></span>`;
    }

    // æ¸²æŸ“è¡¨æ ¼ï¼›ç‰¹ä¾‹ï¼šå°šæœªå…¬å¸ƒ
    function render(list){
      $tbody.innerHTML = list.map(it => {
        const isPending = String(it[COL.name]) === 'å°šæœªå…¬å¸ƒ';
        if (isPending){
          return `
            <tr>
              <td class="rank"></td>
              <td colspan="3" style="text-align:center;color:#0b3aa7;font-weight:600;">å°šæœªå…¬å¸ƒ</td>
            </tr>
          `;
        }
        const rankCell = rankBadge(it[COL.rank]);
        const score = (it[COL.score] ?? '') === '' ? '' : `<b>${it[COL.score]}</b>`;
        return `
          <tr>
            <td class="rank">${rankCell}</td>
            <td>${it[COL.name] ?? ''}</td>
            <td class="group">${it[COL.group] ?? ''}</td>
            <td class="score">${score}</td>
          </tr>
        `;
      }).join('');
    }

    function apply(){
      const sel = $sheet.value;

      if (!sel){
        render([]);
        $emptyBelow.textContent = 'è«‹é¸æ“‡çµ„åˆ¥';
        showEmptyBelow(true);
        return;
      }

      if (dataset.length === 0){
        render([]);
        $emptyBelow.textContent = `${sel} å°šæœªå…¬å¸ƒ`;
        showEmptyBelow(true);
        return;
      }

      // è‹¥åªæœ‰ä¸€åˆ—ä¸”å§“å=å°šæœªå…¬å¸ƒï¼Œç›´æ¥é¡¯ç¤º
      if (dataset.length === 1 && String(dataset[0][COL.name]) === 'å°šæœªå…¬å¸ƒ'){
        render(dataset);
        showEmptyBelow(false);
        return;
      }

      // å¾Œç«¯å·²ä¾è¦å‰‡ï¼ˆå‰3æˆ–å‰8ï¼‰ç¯©å¥½ï¼Œç›´æ¥é¡¯ç¤º
      render(dataset);
      showEmptyBelow(false);
    }

    async function loadAll(){
      try{
        showLoading(true);
        const url = `${SCRIPT_URL}?all=1&ts=${Date.now()}`;
        const res = await fetch(url, {cache:'no-store'});
        const data = await res.json();

        const rows = Array.isArray(data) ? data : (data.rows || []);
        allData = rows.map(r => ({
          [COL.name]:  r[COL.name],
          [COL.group]: norm(r[COL.group] ?? ''),
          [COL.score]: toNumber(r[COL.score]),
          [COL.rank]:  r[COL.rank]
        }));

        // çµ„åˆ¥æ¸…å–®ï¼ˆå„ªå…ˆç”¨ meta.sheetsï¼Œå…¶æ¬¡å¾è³‡æ–™å–ï¼‰
        const names = (data.meta && Array.isArray(data.meta.sheets))
          ? data.meta.sheets.map(s => s.name)
          : Array.from(new Set(allData.map(x => x[COL.group]).filter(Boolean))).sort();

        // é‡å»ºä¸‹æ‹‰
        for (let i=$sheet.options.length-1; i>=1; i--) $sheet.remove(i);
        names.forEach(n=>{
          const opt = document.createElement('option');
          opt.value = n; opt.textContent = n; $sheet.appendChild(opt);
        });

        dataset = [];
        showEmptyBelow(true);
      }catch(err){
        alert('è®€å–è³‡æ–™å¤±æ•—ï¼š' + (err.message||err));
      }finally{
        showLoading(false);
      }
    }

    // é‡æ–°è¼‰å…¥ç›®å‰é¸æ“‡çš„çµ„åˆ¥ï¼ˆå³æ™‚ï¼‰
    async function reloadCurrentGroup(){
      const sel = $sheet.value;
      if (!sel){ alert("è«‹å…ˆé¸æ“‡çµ„åˆ¥å†é‡æ–°è¼‰å…¥"); return; }
      showLoading(true);
      try{
        const url = `${SCRIPT_URL}?sheet=${encodeURIComponent(sel)}&ts=${Date.now()}`;
        const res = await fetch(url, {cache:'no-store'});
        const data = await res.json();

        const rows = Array.isArray(data) ? data : (data.rows || []);
        dataset = rows.map(r => ({
          [COL.name]:  r[COL.name],
          [COL.group]: norm(r[COL.group] ?? ''),
          [COL.score]: toNumber(r[COL.score]),
          [COL.rank]:  r[COL.rank]
        }));

        apply();
      }catch(err){
        alert("é‡æ–°è¼‰å…¥å¤±æ•—ï¼š" + (err.message || err));
      }finally{
        showLoading(false);
      }
    }

    // äº‹ä»¶
    $sheet.addEventListener('change', ()=>{
      const sel = $sheet.value;
      dataset = sel ? allData.filter(it => norm(it[COL.group]) === norm(sel)) : [];
      apply();
    });
    $btnClr.addEventListener('click', ()=>{ $sheet.value=''; dataset=[]; apply(); });
    $btnRel.addEventListener('click', reloadCurrentGroup);

    // åˆå§‹åŒ–
    loadAll();
  </script>
</body>
</html>
