<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å ±åè³‡æ–™å¾Œå°</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";

    const firebaseConfig = {
    apiKey: "AIzaSyCzje5-iL_hI2hlrJsS6aorsIs-ZPMqMpo",
    authDomain: "kaidrum-8c957.firebaseapp.com",
    databaseURL: "https://kaidrum-8c957-default-rtdb.firebaseio.com",
    projectId: "kaidrum-8c957",
    storageBucket: "kaidrum-8c957.firebasestorage.app",
    messagingSenderId: "710792220659",
    appId: "1:710792220659:web:523db5384fcb174b5a0c86",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const fields = {
      NAME: "å§“å",
      BIRTH: "ç”Ÿæ—¥",
      ADDRESS: "è¯çµ¡åœ°å€",
      EMAIL: "è¯çµ¡ä¿¡ç®±",
      PHONE: "è¯çµ¡é›»è©±",
      TEACHER: "æŒ‡å°è€å¸«",
      SONG: "æ›²ç›®",
      GROUP: "å ±åçµ„åˆ¥",
      PAYMENT: "å¸³è™Ÿå¾Œäº”ç¢¼",
    };

    let tableData = [];

    // ğŸ”’ ç™»å…¥ç‹€æ…‹ç›£è½
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("login-section").style.display = "none";
        document.getElementById("admin-section").style.display = "block";
        loadData(); // è¼‰å…¥å ±åè³‡æ–™
      } else {
        document.getElementById("login-section").style.display = "block";
        document.getElementById("admin-section").style.display = "none";
      }
    });

    // â© ç™»å…¥åŠŸèƒ½
    window.login = function () {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("ç™»å…¥æˆåŠŸï¼");
        })
        .catch((err) => {
          alert("ç™»å…¥å¤±æ•—ï¼š" + err.message);
        });
    };

    // â¬‡ è¼‰å…¥å ±åè³‡æ–™ä¸¦å»ºç«‹è¡¨æ ¼
    async function loadData() {
      const snapshot = await getDocs(collection(db, "users"));
      snapshot.forEach((doc) => {
        const data = doc.data();
        const row = [];
        for (let key in fields) {
          row.push(data[key] || "");
        }
        tableData.push(row);

        const tr = document.createElement("tr");
        row.forEach((cell) => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        document.getElementById("table-body").appendChild(tr);
      });

      $('#dataTable').DataTable();
    }

    // â¬‡ åŒ¯å‡º Excel
    window.exportExcel = function () {
      const wb = XLSX.utils.book_new();
      const ws_data = [Object.values(fields), ...tableData];
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "å ±åè³‡æ–™");
      XLSX.writeFile(wb, "å ±åè³‡æ–™.xlsx");
    };
  </script>

  <!-- ç¬¬ä¸‰æ–¹å¥—ä»¶ -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body style="font-family: Arial, sans-serif; background: #f9f9f9; padding: 20px;">

  <!-- ğŸ” ç™»å…¥å€å¡Š -->
  <div id="login-section" style="max-width: 400px; margin: auto; display: none;">
    <h2>ç®¡ç†å“¡ç™»å…¥</h2>
    <input id="email" type="email" placeholder="Email" style="width: 100%; padding: 8px; margin-bottom: 10px;"><br/>
    <input id="password" type="password" placeholder="Password" style="width: 100%; padding: 8px;"><br/>
    <button onclick="login()" style="margin-top: 10px;">ç™»å…¥</button>
  </div>

  <!-- ğŸ›  å¾Œå°è³‡æ–™å€ -->
  <div id="admin-section" style="display: none;">
    <h2>ğŸ”¥ å ±åè³‡æ–™å¾Œå°</h2>
    <button onclick="exportExcel()">ğŸ“¤ åŒ¯å‡º Excel</button>
    <table id="dataTable" class="display" style="width:100%; margin-top: 20px;">
      <thead>
        <tr>
          <th>å§“å</th>
          <th>ç”Ÿæ—¥</th>
          <th>è¯çµ¡åœ°å€</th>
          <th>è¯çµ¡ä¿¡ç®±</th>
          <th>è¯çµ¡é›»è©±</th>
          <th>æŒ‡å°è€å¸«</th>
          <th>æ›²ç›®</th>
          <th>å ±åçµ„åˆ¥</th>
          <th>å¸³è™Ÿå¾Œäº”ç¢¼</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

</body>
</html>
