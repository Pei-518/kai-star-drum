<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¯”è³½æˆç¸¾æŸ¥è©¢</title>
  <style>
    :root{
      --bg:#f0f5ff; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --primary:#1d4ed8; --primary-weak:#dbeafe; --border:#e5e7eb;
      --thead:#eff6ff; --radius:16px; --shadow:0 10px 24px rgba(2,6,23,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Arial,"Apple Color Emoji";}
    .container{max-width:980px;margin:28px auto;padding:0 16px}
    h1{font-size:26px;margin:0 0 16px;text-align:center;color:#0b3aa7}

    .card{background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;}

    header.controls{display:grid;gap:12px;grid-template-columns: 1fr max-content max-content;align-items:end;margin-bottom:12px}
    @media (max-width:720px){header.controls{grid-template-columns:1fr;}}
    label{font-size:13px;color:var(--muted)}
    select,button{width:100%;font-size:16px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    select:focus{outline:2px solid var(--primary-weak);border-color:var(--primary)}
    .btn{background:#eff6ff;color:#0b3aa7;border:1px solid #c7d2fe;cursor:pointer}

    .table-wrap{
      margin-top:4px;border:1px solid var(--border);border-radius:12px;
      overflow:auto;background:#fff;box-shadow:var(--shadow);position:relative;
      min-height:160px;
    }
    table{width:100%;border-collapse:collapse;min-width:480px;table-layout:fixed}
    thead th{
      position:sticky;top:0;z-index:2;
      background:var(--thead);color:#0b3aa7;font-weight:700;
      border-bottom:1px solid #c7d2fe;padding:10px 12px;text-align:left
    }
    tbody td{border-bottom:1px solid var(--border);padding:10px 12px;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    tbody tr:nth-child(odd){background:#f8fbff}
    tbody tr:hover{background:#eef5ff}
    th.rank, td.rank{width:120px}
    th.group, td.group{width:160px}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border-radius:999px;font-weight:700;font-size:14px;background:#e0e7ff;color:#1e3a8a;border:1px solid #c7d2fe}
    .rank-1{background:#ffeab5;color:#8a4b00;border-color:#ffd58a}
    .rank-2{background:#e2e8f0;color:#334155;border-color:#cbd5e1}
    .rank-3{background:#fde68a;color:#7c2d12;border-color:#fcd34d}

    /* å…§å±¤ loadingï¼ˆè¡¨æ ¼ç”¨ï¼‰ */
    .loading{
      position:absolute;inset:0;display:none;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(239,246,255,.85), rgba(239,246,255,.6));
      backdrop-filter:saturate(180%) blur(2px);border-radius:12px;
      z-index:3;
    }
    .loading.show{display:flex}
    .spinner{width:42px;height:42px;border-radius:50%;border:4px solid #c7d2fe;border-top-color:#1d4ed8;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .empty-below{display:none;text-align:center;color:#0b3aa7;margin-top:14px;padding:14px 12px;background:#f5f9ff;border:1px dashed #c7d2fe;border-radius:12px}
    .empty-below.show{display:block}
    td.pending{ text-align:center;color:#0b3aa7;font-weight:600; }

    /* å…¨è¢å¹•å•Ÿå‹• loadingï¼ˆé€²ç«™ç«‹åˆ»å¯è¦‹ï¼‰ */
    .boot-loading{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(240,245,255,.95);z-index:9999;
    }
    .boot-loading.show{display:flex}
    .boot-box{
      display:flex;flex-direction:column;align-items:center;gap:14px;
      padding:18px 22px;border-radius:14px;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow);
      color:#0b3aa7;font-weight:600
    }
    .boot-spinner{width:46px;height:46px;border-radius:50%;border:4px solid #c7d2fe;border-top-color:#1d4ed8;animation:spin .9s linear infinite}
  </style>
</head>
<body>
  <!-- å…¨è¢å¹•å•Ÿå‹•è¼‰å…¥å±¤ -->
  <div id="bootLoading" class="boot-loading show" aria-live="polite" aria-busy="true">
    <div class="boot-box">
      <div class="boot-spinner"></div>
      <div>æ­£åœ¨è¼‰å…¥æˆç¸¾â€¦</div>
    </div>
  </div>

  <div class="container" aria-busy="false">
    <h1>æ¯”è³½æˆç¸¾æŸ¥è©¢</h1>

    <div class="card">
      <header class="controls">
        <div>
          <label for="sheetSelect">åˆ†é ï¼ˆçµ„åˆ¥ï¼‰</label>
          <select id="sheetSelect" aria-label="é¸æ“‡çµ„åˆ¥">
            <option value="">é¸æ“‡çµ„åˆ¥</option>
          </select>
        </div>
        <button id="btnReload" class="btn" type="button">é‡æ–°è¼‰å…¥</button>
        <button id="btnClear"  class="btn" type="button">æ¸…é™¤</button>
      </header>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th class="rank">çµ„å…§åæ¬¡</th>
              <th>å§“å</th>
              <th class="group">çµ„åˆ¥</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="loading" class="loading"><div class="spinner"></div></div>
      </div>

      <div id="emptyBelow" class="empty-below">è«‹é¸æ“‡çµ„åˆ¥</div>
      <div id="perf" style="margin-top:8px;color:#64748b;font-size:12px;"></div>
    </div>
  </div>

  <script>
    // â˜… æ›æˆä½ çš„ Apps Script Web App é€£çµ
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxP_yXeH9IRUOgi40tsNzW5Rzd70KAfGifg5dx3R0gYJuM8YLTieoq4zlkyrNCF3wEp/exec";
    // â˜… æ›æˆä½ çš„ Google è©¦ç®—è¡¨ IDï¼ˆCSV å‚™æ´ç”¨ï¼‰
    const SHEET_ID  = "16djx-tUT59GxMjziCHYcBmON1JdOAkKERb1e2BqO9uY";

    const COL = { name:"å§“å", group:"çµ„åˆ¥", ranking:"åæ¬¡" };

    const $sheet = document.getElementById('sheetSelect');
    const $tbody = document.querySelector('#tbl tbody');
    const $btnClr = document.getElementById('btnClear');
    const $btnRel = document.getElementById('btnReload');
    const $loading = document.getElementById('loading');
    const $emptyBelow = document.getElementById('emptyBelow');
    const $boot = document.getElementById('bootLoading');
    const $perf = document.getElementById('perf');

    let dataset = [];
    let currentAbort = null;

    // é€¾æ™‚ç‰ˆ fetch
    async function fetchWithTimeout(url, ms = 10000, opts = {}) {
      const ac = new AbortController();
      const t = setTimeout(() => ac.abort(), ms);
      try {
        const res = await fetch(url, { ...opts, signal: ac.signal, cache:'no-store' });
        return res;
      } finally {
        clearTimeout(t);
      }
    }

    // ç°¡æ˜“ CSV è§£æï¼ˆç„¡å¤šè¡Œæ¬„ä½ï¼‰
    function csvToRows(csv) {
      return csv.trim().split(/\r?\n/).map(line =>
        line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s => s.replace(/^"|"$/g,''))
      );
    }

    const showLoading = on => $loading.classList.toggle('show', !!on);
    const showBoot = on => $boot.classList.toggle('show', !!on);
    const showEmptyBelow = on => $emptyBelow.classList.toggle('show', !!on);
    const norm = s => String(s || '').trim();

    function rankBadge(rank){
      const n = Number(rank);
      if (!n) return '';
      if (n === 1 || n === 2 || n === 3){
        const medal = n===1?'ğŸ¥‡':n===2?'ğŸ¥ˆ':'ğŸ¥‰';
        const cls = n===1?'rank-1':n===2?'rank-2':'rank-3';
        return `<span class="badge ${cls}">${medal}<span>${n}</span></span>`;
      }
      return `<span class="badge"><span>${n}</span></span>`;
    }

    function render(list){
      $tbody.innerHTML = list.map(it => {
        const isPending = String(it[COL.name]) === 'å°šæœªå…¬å¸ƒ';
        if (isPending){
          return `<tr><td class="pending" colspan="3">å°šæœªå…¬å¸ƒ</td></tr>`;
        }
        return `
          <tr>
            <td class="rank">${rankBadge(it[COL.ranking])}</td>
            <td>${it[COL.name] ?? ''}</td>
            <td class="group">${it[COL.group] ?? ''}</td>
          </tr>`;
      }).join('');
    }

    function apply(){
      const sel = $sheet.value;
      if (!sel){
        render([]);
        $emptyBelow.textContent = 'è«‹é¸æ“‡çµ„åˆ¥';
        showEmptyBelow(true);
        return;
      }
      render(dataset);
      showEmptyBelow(false);
    }

    // é¦–æ¬¡åªæŠ“æ¸…å–®
    async function loadAll(){
      showBoot(true);
      try{
        const res = await fetchWithTimeout(`${SCRIPT_URL}?meta=1&ts=${Date.now()}`, 10000);
        const data = await res.json();

        for (let i=$sheet.options.length-1; i>=1; i--) $sheet.remove(i);
        (data.meta?.sheets || []).forEach(s=>{
          const opt = document.createElement('option');
          opt.value = s.name; opt.textContent = s.name;
          $sheet.appendChild(opt);
        });

        dataset = [];
        showEmptyBelow(true);
        //if ($perf && data?.meta?.exec_ms != null) {
          //$perf.textContent = `å¾Œç«¯åŸ·è¡Œæ™‚é–“ï¼š${data.meta.exec_ms} ms`;
        //}
      }catch(err){
        alert('è®€å–æ¸…å–®å¤±æ•—ï¼š' + (err.name === 'AbortError' ? 'é€£ç·šé€¾æ™‚' : (err.message||err)));
      }finally{
        showBoot(false);
      }
    }

    // Apps Script å¤±æ•— â†’ æ”¹æŠ“ CSV å‚™æ´
    async function fallbackCsv(sel){
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sel)}`;
      const res = await fetchWithTimeout(url, 8000);
      if (!res.ok) throw new Error('CSV å‚™æ´ä¹Ÿå¤±æ•—');
      const csv = await res.text();
      const rows2d = csvToRows(csv);
      if (rows2d.length < 2) throw new Error('CSV ç„¡è³‡æ–™');

      const headers = rows2d[0];
      const idxName = headers.indexOf('å§“å');
      const idxGroup = headers.indexOf('çµ„åˆ¥');
      const idxRank  = headers.indexOf('åæ¬¡');

      const list = [];
      for (let i=1;i<rows2d.length;i++){
        const r = rows2d[i];
        const rank = Number(r[idxRank]);
        if (!Number.isFinite(rank) || rank < 1) continue;
        list.push({
          'å§“å': r[idxName],
          'çµ„åˆ¥': idxGroup >= 0 ? r[idxGroup] : sel,
          'åæ¬¡': rank
        });
      }
      dataset = list.sort((a,b)=> a['åæ¬¡'] - b['åæ¬¡']);
      apply();
      alert('Apps Script ç·©æ…¢ï¼Œå·²æ”¹ç”¨ CSV å‚™æ´ã€‚');
    }

    // é‡æ–°è¼‰å…¥ç›®å‰çµ„åˆ¥
    async function reloadCurrentGroup(){
      const sel = $sheet.value;
      if (!sel){ alert("è«‹å…ˆé¸æ“‡çµ„åˆ¥å†é‡æ–°è¼‰å…¥"); return; }

      if (currentAbort) currentAbort.abort();
      currentAbort = new AbortController();

      showLoading(true);
      try{
        const res = await fetchWithTimeout(
          `${SCRIPT_URL}?sheet=${encodeURIComponent(sel)}&ts=${Date.now()}`,
          10000,
          { signal: currentAbort.signal }
        );
        const data = await res.json();
        dataset = (data.rows||[]).map(r => ({
          [COL.name]: r[COL.name],
          [COL.group]: norm(r[COL.group]),
          [COL.ranking]: r[COL.ranking]
        }));
        //if ($perf && data?.meta?.exec_ms != null) {
          //$perf.textContent = `å¾Œç«¯åŸ·è¡Œæ™‚é–“ï¼š${data.meta.exec_ms} ms`;
        //}
        apply();
      }catch(err){
        // å¾Œç«¯é€¾æ™‚/å¤±æ•— â†’ CSV å‚™æ´
        try {
          await fallbackCsv(sel);
        } catch (e2) {
          alert("é‡æ–°è¼‰å…¥å¤±æ•—ï¼ˆå«å‚™æ´ï¼‰ï¼š" + (e2.message || e2));
        }
      }finally{
        showLoading(false);
        currentAbort = null;
      }
    }

    // äº‹ä»¶
    $sheet.addEventListener('change', ()=>{
      dataset = [];
      render([]);
      showEmptyBelow(false);
      reloadCurrentGroup();
    });
    $btnClr.addEventListener('click', ()=>{ $sheet.value=''; dataset=[]; apply(); });
    $btnRel.addEventListener('click', reloadCurrentGroup);

    // å•Ÿå‹•
    window.addEventListener('DOMContentLoaded', loadAll);
  </script>
</body>
</html>
